SELECT 
    ext.ext,
    CASE 
        WHEN position('_' IN ext.remark) > 0 THEN
            split_part(ext.remark, '_', 1)
        WHEN position(' ' IN ext.remark) > 0 THEN
            split_part(ext.remark, ' ', 1)
        ELSE
            ext.remark
    END AS name,
    CASE 
        WHEN position('_' IN ext.remark) > 0 THEN
            to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
        WHEN position(' ' IN ext.remark) > 0 THEN
            to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
        ELSE
            NULL
    END AS extracted_date,
    p2.extid,
    p2.valuetext AS usemode_valuetext,
    p1.valuetext AS sim_status_contract,
    iccid.valuetext AS ICCID
FROM 
    dbo.m2mextension ext
JOIN 
    dbo.m2mpropsimtypestoterbank typter ON ext.idr = typter.extid AND typter.dateto > NOW()
JOIN 
    dbo.mobsimtypesclassestoterbank classter ON typter.simtypesid = classter.idr
JOIN 
    dbo.mobsimtypes typ ON classter.simtypeid = typ.id
JOIN 
    dbo.m2mextenssionproperty p2 ON ext.idr = p2.extid
JOIN 
    dbo.m2mextenssionproperty p1 ON ext.idr = p1.extid
LEFT JOIN 
    (SELECT extid, valuetext 
     FROM dbo.m2mextenssionproperty 
     WHERE propertyfiedid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
WHERE 
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        ) 
        AND dateto > NOW()
    )
    AND ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext = 'Первоначальная блокировка'
    ) 
    AND (
        (
            split_part(ext.remark, ' ', 1) = 'UPOS'
            AND typ."name" IN ('POS-терминал', 'SmartPos')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        ) 
        OR 
        (
            split_part(ext.remark, ' ', 1) = 'SDWAN'
            AND typ."name" IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        )
    )
    AND p1.propertyfiedid = (
        SELECT idr 
        FROM dbo.tarPropertyField 
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    ) 
    AND p1.dateto > NOW() 
    AND LOWER(p1.valuetext) = LOWER('в договоре');

____________________________________________________________
SELECT 
    ext.ext,
    ext.remark,
    p2.extid,
    p2.valuetext AS usemode_valuetext,
    p1.valuetext AS sim_status_contract,
    iccid.valuetext AS ICCID
FROM 
    dbo.m2mextension ext
JOIN 
    dbo.m2mpropsimtypestoterbank typter ON ext.idr = typter.extid AND typter.dateto > NOW()
JOIN 
    dbo.mobsimtypesclassestoterbank classter ON typter.simtypesid = classter.idr
JOIN 
    dbo.mobsimtypes typ ON classter.simtypeid = typ.id
JOIN 
    dbo.m2mextenssionproperty p2 ON ext.idr = p2.extid
JOIN 
    dbo.m2mextenssionproperty p1 ON ext.idr = p1.extid
LEFT JOIN 
    (SELECT extid, valuetext 
     FROM dbo.m2mextenssionproperty 
     WHERE propertyfiedid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
WHERE 
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        ) 
        AND dateto > NOW()
    )
    AND ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext = 'Первоначальная блокировка'
    ) 
    AND (
        (
            split_part(ext.remark, ' ', 1) = 'UPOS'
            AND typ."name" IN ('POS-терминал', 'SmartPos')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        ) 
        OR 
        (
            split_part(ext.remark, ' ', 1) = 'SDWAN'
            AND typ."name" IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        )
    )
    AND p1.propertyfiedid = (
        SELECT idr 
        FROM dbo.tarPropertyField 
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    ) 
    AND p1.dateto > NOW() 
    AND LOWER(p1.valuetext) = LOWER('в договоре');
__________________________________________________________________________________________
SELECT
    op.name AS operator,
    ext.ext AS msisdn,
    iccid.valuetext AS iccid,
    typ.name AS m2m_usemode,
    NULL AS status_block,
    NULL AS tb,
    c.name AS gosb,
    NULL AS date_block,
    p1.valuetext AS dog_status
FROM
    dbo.m2mextension ext
JOIN
    dbo.taraccounts acc ON ext.accoutid = acc.id
JOIN
    dbo.taroperator op ON acc.operatorid = op.idr
JOIN
    dbo.m2mpropgosbtoterbank mm ON ext.idr = mm.extid   
JOIN
    dbo.catgosbtoterbank c ON c.id = mm.gostoterbankid 
JOIN
    dbo.m2mpropsimtypestoterbank typer ON ext.idr = typer.extid AND typer.dateto > NOW()    
JOIN
    dbo.mobsimtypesclassestoterbank classter ON typer.simtypesid = classter.idr      
JOIN
    dbo.mobsimtypes typ ON classter.simtypeid = typ.id 
JOIN
    dbo.m2mextensionproperty p2 ON ext.idr = p2.extid
JOIN
    dbo.m2mextensionproperty p1 ON ext.idr = p1.extid
LEFT JOIN
    (SELECT extid, valuetext
     FROM dbo.m2mextensionproperty 
     WHERE propertyfieldid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
WHERE
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextensionproperty 
        WHERE propertyfieldid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        )
    AND dateto > NOW()
    )
    AND ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextensionproperty 
        WHERE propertyfieldid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext = 'Первоначальная блокировка'
    )
    AND p1.propertyfieldid = (
        SELECT idr 
        FROM dbo.tarPropertyField
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    )
    AND p1.dateto > NOW()
    AND LOWER(p1.valuetext) = LOWER('в договоре')
    AND (
        (
            split_part(p2.valuetext, ' ', 1) = 'UPOS'
            AND typ.name IN ('POS-терминал', 'SmartPos')
            AND CASE 
                WHEN position(' ' IN p2.valuetext) > 0 THEN
                    to_date(substring(p2.valuetext, position(' ' IN p2.valuetext) + 1), 'DD.MM.YYYY')  
                ELSE
                    NULL  
            END < date_trunc('month', NOW()) - INTERVAL '2 months'
        )
        OR
        (
            split_part(p2.valuetext, '_', 1) = 'SDWAN'
            AND typ.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE
                WHEN position('_' IN p2.valuetext) > 0 THEN
                    to_date(substring(p2.valuetext, position('_' IN p2.valuetext) + 1), 'YYYY-MM-DD')
                ELSE 
                    NULL
                END < date_trunc('month', NOW()) - INTERVAL '2 months'        
        )
    );
______________________________________________________________________________________________________
CASE
        WHEN position('_' IN p2.valuetext) > 0 THEN
            split_part(p2.valuetext, '_', 1) || ' ' || to_char(to_timestamp(substring(p2.valuetext, position('_' IN p2.valuetext) + 1, 19), 'YYYY-MM-DD HH24:MI:SS'), 'DD.MM.YYYY')
        ELSE
            p2.valuetext
    END AS m2m_usemode
______________________________________
select 
    p1.valuetext as sim_status_contract,
    p2.extid,
    p2.valuetext as usemode_valuetext,
    p2.datefrom
from 
    dbo.m2mextenssionproperty p1
join 
    dbo.m2mextenssionproperty p2 on p1.extid = p2.extid
where 
    p1.propertyfiedid = (
        select idr
        from dbo.tarPropertyField
        where privatename = 'M2M_SIM_STATUS_CONTRACT'
    ) 
    and p1.dateto > now() 
    and lower(p1.valuetext) = lower('в договоре')
    and p2.propertyfiedid = (
        select idr
        from dbo.tarPropertyField
        where privatename = 'M2M_USEMODE'
    ) 
    and p2.dateto > now() 
    and p2.valuetext like 'UPOS%' 
    and p2.datefrom < now() - interval '2 months';
_____________________________________________________________
CREATE OR REPLACE FUNCTION get_filtered_m2m_data(
    current_date DATE,
    device_types_sdw TEXT[],
    device_types_upos TEXT[]
)
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    data VARCHAR
) AS $$
DECLARE
    prev_month_1 DATE := date_trunc('month', current_date);
    prev_month_2 DATE := date_trunc('month', current_date) - INTERVAL '1 month';
    sql_query TEXT;
BEGIN
    -- Формируем динамический SQL запрос для проверки трафика за последние два месяца
    sql_query := format($f$
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS data
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid 
            AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = LOWER('в договоре')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = 'M2M_ICCID'
             ) 
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_DONT_BLOCK'
                )
                AND dateto > NOW()
            )
            AND ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_STATUS'
                )
                AND dateto > NOW()
                AND valuetext = 'Первоначальная блокировка'
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_STATUS'
                )
                AND dateto > NOW()
                AND (valuetext = 'Активен' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, ' ', 1) = 'UPOS'
                    AND st.name = ANY(device_types_upos)
                    AND CASE 
                        WHEN position(' ' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                        ELSE
                            NULL  
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
                OR
                (
                    split_part(ep.valuetext, '_', 1) = 'SDWAN'
                    AND st.name = ANY(device_types_sdw)
                    AND CASE
                        WHEN position('_' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                        ELSE 
                            NULL
                        END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
            )
            AND ext.idr NOT IN (
                SELECT extid
                FROM (
                    SELECT extid FROM aggmobilecalls_%s
                    UNION ALL
                    SELECT extid FROM aggmobilecalls_%s
                ) t
            )
        $f$, to_char(prev_month_1, 'YYYYMM'), to_char(prev_month_2, 'YYYYMM'));
    
    RETURN QUERY EXECUTE sql_query;
END;
$$ LANGUAGE plpgsql;
__________________________________________________________________________________
CREATE OR REPLACE FUNCTION get_filtered_m2m_data(
    current_date DATE
)
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    data VARCHAR
) AS $$
DECLARE
    prev_month_1 DATE := date_trunc('month', current_date);
    prev_month_2 DATE := date_trunc('month', current_date) - INTERVAL '1 month';
    sql_query TEXT;
BEGIN
    -- Формируем динамический SQL запрос для проверки трафика за последние два месяца
    sql_query := format($f$
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS data
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = LOWER('в договоре')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = 'M2M_ICCID'
             ) 
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_DONT_BLOCK'
                )
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_STATUS'
                )
                AND dateto > NOW()
                AND valuetext != 'Первоначальная блокировка'
                AND (valuetext = 'Активен' OR valuetext IS NULL)
            )
            AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
            AND (
                (
                    split_part(ep.valuetext, ' ', 1) = 'UPOS'
                    AND st.name IN ('POS-терминал', 'SmartPos')
                    AND CASE 
                        WHEN position(' ' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                        ELSE
                            NULL  
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
                OR
                (
                    split_part(ep.valuetext, '_', 1) = 'SDWAN'
                    AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
                    AND CASE
                        WHEN position('_' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                        ELSE 
                            NULL
                        END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
            )
            AND ext.idr NOT IN (
                SELECT extid
                FROM (
                    SELECT extid FROM aggmobilecalls_%s WHERE servicetype = 'интернет'
                    UNION ALL
                    SELECT extid FROM aggmobilecalls_%s WHERE servicetype = 'интернет'
                ) t
            )
        $f$, to_char(prev_month_1, 'YYYYMM'), to_char(prev_month_2, 'YYYYMM'));
    
    RETURN QUERY EXECUTE sql_query;
END;
$$ LANGUAGE plpgsql;
____________________________________________________________________
CREATE OR REPLACE FUNCTION get_filtered_m2m_data(
    current_date DATE
)
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    data VARCHAR
) AS $$
DECLARE
    prev_month_1 TEXT := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 TEXT := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');
    sql_query TEXT;
BEGIN
    -- Формируем динамический SQL запрос для проверки трафика за последние два месяца
    sql_query := format($f$
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS data
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = LOWER('в договоре')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = 'M2M_ICCID'
             ) 
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_DONT_BLOCK'
                )
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_STATUS'
                )
                AND dateto > NOW()
                AND valuetext != 'Первоначальная блокировка'
                AND (valuetext = 'Активен' OR valuetext IS NULL)
            )
            AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
            AND (
                (
                    split_part(ep.valuetext, ' ', 1) = 'UPOS'
                    AND st.name IN ('POS-терминал', 'SmartPos')
                    AND CASE 
                        WHEN position(' ' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                        ELSE
                            NULL  
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
                OR
                (
                    split_part(ep.valuetext, '_', 1) = 'SDWAN'
                    AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
                    AND CASE
                        WHEN position('_' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                        ELSE 
                            NULL
                        END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
            )
            AND ext.idr NOT IN (
                SELECT extid FROM aggmobilecalls_%s WHERE servicetype = 'интернет'
                UNION ALL
                SELECT extid FROM aggmobilecalls_%s WHERE servicetype = 'интернет'
            )
        $f$, prev_month_1, prev_month_2);
    
    RETURN QUERY EXECUTE sql_query;
END;
$$ LANGUAGE plpgsql;
_____________________________________________________________________________________
SELECT
    op.name AS operator,
    ext.ext AS msisdn,
    iccid.valuetext AS iccid,
    st.name AS m2m_type,
    CASE
        WHEN position('_' IN ep.valuetext) > 0 THEN
            split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
        ELSE
            ep.valuetext
    END AS m2m_usemode,
    tb.fullname AS tb,
    g.name AS gosb,
    NULL AS status,
    NULL AS data
FROM
    dbo.m2mextension ext
JOIN
    dbo.taraccounts acc ON ext.accoutid = acc.id
JOIN
    dbo.taroperator op ON acc.operatorid = op.idr
JOIN
    dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
JOIN
    dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
JOIN
    dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
JOIN
    dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
JOIN
    dbo.mobsimtypes st ON stc.simtypeid = st.id 
JOIN
    dbo.m2mextensionproperty ep ON ext.idr = ep.extid
JOIN
    dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
        SELECT idr 
        FROM dbo.tarPropertyField
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    )
    AND p1.dateto > NOW()
    AND LOWER(p1.valuetext) = LOWER('в договоре')
LEFT JOIN
    (SELECT extid, valuetext
     FROM dbo.m2mextensionproperty 
     WHERE propertyfieldid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
JOIN
    dbo.catterbank tb ON tb.id = acc.terbankid
WHERE
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextensionproperty 
        WHERE propertyfieldid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        )
        AND dateto > NOW()
    )
    AND ext.idr IN (
        SELECT extid
        FROM dbo.m2mextensionproperty 
        WHERE propertyfieldid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext != 'Первоначальная блокировка'
        AND (valuetext = 'Активен' OR valuetext IS NULL)
    )
    AND (
        (
            split_part(ep.valuetext, ' ', 1) = 'UPOS'
            AND st.name IN ('POS-терминал', 'SmartPos')
            AND CASE 
                WHEN position(' ' IN ep.valuetext) > 0 THEN
                    to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                ELSE
                    NULL  
            END < date_trunc('month', NOW()) - INTERVAL '2 months'
        )
        OR
        (
            split_part(ep.valuetext, '_', 1) = 'SDWAN'
            AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                ELSE 
                    NULL
            END < date_trunc('month', NOW()) - INTERVAL '2 months'
        )
    )
    AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
    AND ext.idr NOT IN (
        SELECT extid 
        FROM aggmobilecalls_202405 
        WHERE servicetype = 'интернет'
        AND call_date BETWEEN current_date - INTERVAL '60 days' AND current_date
    );
______________________________________________________________________________
CREATE OR REPLACE FUNCTION get_filtered_m2m_data(
    current_date DATE
)
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    data VARCHAR
) AS $$
DECLARE
    prev_month_1 TEXT := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 TEXT := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');
BEGIN
    RETURN QUERY EXECUTE format($f$
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS data
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = LOWER('в договоре')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = 'M2M_ICCID'
             ) 
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_DONT_BLOCK'
                )
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = 'M2M_STATUS'
                )
                AND dateto > NOW()
                AND valuetext != 'Первоначальная блокировка'
                AND (valuetext = 'Активен' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, ' ', 1) = 'UPOS'
                    AND st.name IN ('POS-терминал', 'SmartPos')
                    AND CASE 
                        WHEN position(' ' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                        ELSE
                            NULL  
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
                OR
                (
                    split_part(ep.valuetext, '_', 1) = 'SDWAN'
                    AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
                    AND CASE
                        WHEN position('_' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                        ELSE 
                            NULL
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
            )
            AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
            AND ext.idr NOT IN (
                SELECT extid 
                FROM (
                    SELECT extid 
                    FROM aggmobilecalls_%s 
                    WHERE servicetype = 'интернет'
                    UNION
                    SELECT extid 
                    FROM aggmobilecalls_%s 
                    WHERE servicetype = 'интернет'
                ) t
            )
        $f$, prev_month_1, prev_month_2);

END;
$$ LANGUAGE plpgsql;
_______________________________________________________________________________-
упрощенный !!!!!
CREATE OR REPLACE FUNCTION get_filtered_m2m_data(
    current_date DATE
)
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    data VARCHAR
) AS $$
DECLARE
    prev_month_1 TEXT := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 TEXT := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');
BEGIN
    RETURN QUERY EXECUTE format($f$
        WITH relevant_calls AS (
            SELECT extid 
            FROM aggmobilecalls_%I 
            WHERE servicetype = 'интернет'
            UNION
            SELECT extid 
            FROM aggmobilecalls_%I 
            WHERE servicetype = 'интернет'
        )
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS data
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid 
            AND p1.propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_SIM_STATUS_CONTRACT')
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = LOWER('в договоре')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_ICCID')
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_DONT_BLOCK')
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_STATUS')
                AND dateto > NOW()
                AND valuetext != 'Первоначальная блокировка'
                AND (valuetext = 'Активен' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, ' ', 1) = 'UPOS'
                    AND st.name IN ('POS-терминал', 'SmartPos')
                    AND CASE 
                        WHEN position(' ' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                        ELSE
                            NULL  
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
                OR
                (
                    split_part(ep.valuetext, '_', 1) = 'SDWAN'
                    AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
                    AND CASE
                        WHEN position('_' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                        ELSE 
                            NULL
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
            )
            AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
            AND ext.idr NOT IN (SELECT extid FROM relevant_calls)
        $f$, prev_month_1, prev_month_2);
END;
$$ LANGUAGE plpgsql;

WITH relevant_calls AS (
    SELECT extid 
    FROM aggmobilecalls_202406 
    WHERE servicetype = 'интернет'
    UNION
    SELECT extid 
    FROM aggmobilecalls_202405 
    WHERE servicetype = 'интернет'
),
dont_block_extids AS (
    SELECT extid
    FROM dbo.m2mextensionproperty 
    WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_DONT_BLOCK')
    AND dateto > NOW()
),
active_extids AS (
    SELECT extid
    FROM dbo.m2mextensionproperty 
    WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_STATUS')
    AND dateto > NOW()
    AND valuetext != 'Первоначальная блокировка'
    AND (valuetext = 'Активен' OR valuetext IS NULL)
),
iccid_properties AS (
    SELECT extid, valuetext
    FROM dbo.m2mextensionproperty 
    WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_ICCID')
    AND dateto > NOW()
),
sim_status_contract_properties AS (
    SELECT extid
    FROM dbo.m2mextensionproperty
    WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = 'M2M_SIM_STATUS_CONTRACT')
    AND dateto > NOW()
    AND LOWER(valuetext) = LOWER('в договоре')
)
SELECT
    op.name AS operator,
    ext.ext AS msisdn,
    iccid.valuetext AS iccid,
    st.name AS m2m_type,
    CASE
        WHEN position('_' IN ep.valuetext) > 0 THEN
            split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
        ELSE
            ep.valuetext
    END AS m2m_usemode,
    tb.fullname AS tb,
    g.name AS gosb,
    NULL AS status,
    NULL AS data
FROM
    dbo.m2mextension ext
JOIN
    dbo.taraccounts acc ON ext.accoutid = acc.id
JOIN
    dbo.taroperator op ON acc.operatorid = op.idr
JOIN
    dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
JOIN
    dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
JOIN
    dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()    
JOIN
    dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
JOIN
    dbo.mobsimtypes st ON stc.simtypeid = st.id 
JOIN
    dbo.m2mextensionproperty ep ON ext.idr = ep.extid
JOIN
    sim_status_contract_properties sscp ON ext.idr = sscp.extid
LEFT JOIN
    iccid_properties iccid ON ext.idr = iccid.extid
JOIN
    dbo.catterbank tb ON tb.id = acc.terbankid
WHERE
    ext.idr NOT IN (SELECT extid FROM dont_block_extids)
    AND ext.idr IN (SELECT extid FROM active_extids)
    AND (
        (
            split_part(ep.valuetext, ' ', 1) = 'UPOS'
            AND st.name IN ('POS-терминал', 'SmartPos')
            AND CASE 
                WHEN position(' ' IN ep.valuetext) > 0 THEN
                    to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')  
                ELSE
                    NULL  
            END < date_trunc('month', NOW()) - INTERVAL '2 months'
        )
        OR
        (
            split_part(ep.valuetext, '_', 1) = 'SDWAN'
            AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                ELSE 
                    NULL
            END < date_trunc('month', NOW()) - INTERVAL '2 months'
        )
    )
    AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
    AND ext.idr NOT IN (SELECT extid FROM relevant_calls);


CREATE OR REPLACE FUNCTION get_filtered_m2m_data()
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    data VARCHAR
) AS $$
DECLARE
    current_date DATE := CURRENT_DATE;
    current_month TEXT;
    prev_month_1 TEXT;
    prev_month_2 TEXT;
    query TEXT;
BEGIN
    current_month := to_char(current_date, 'YYYYMM');
    prev_month_1 := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');

    query := format('
        WITH relevant_calls AS (
            SELECT extid FROM aggmobilecalls_%I WHERE servicetype = ''интернет''
            UNION ALL
            SELECT extid FROM aggmobilecalls_%I WHERE servicetype = ''интернет''
            UNION ALL
            SELECT extid FROM aggmobilecalls_%I WHERE servicetype = ''интернет''
        ),
        dont_block_extids AS (
            SELECT extid
            FROM dbo.m2mextensionproperty 
            WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = ''M2M_DONT_BLOCK'')
            AND dateto > CURRENT_DATE
        ),
        active_extids AS (
            SELECT extid
            FROM dbo.m2mextensionproperty 
            WHERE propertyfieldid = (SELECT idr FROM dbo.tarPropertyField WHERE privatename = ''M2M_STATUS'')
            AND dateto > CURRENT_DATE
            AND valuetext != ''Первоначальная блокировка''
            AND (valuetext = ''Активен'' OR valuetext IS NULL)
        )
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position(''_'', ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, ''_'', 1) || ''_'' || substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS data
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > CURRENT_DATE    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = ''M2M_SIM_STATUS_CONTRACT''
            )
            AND p1.dateto > CURRENT_DATE
            AND LOWER(p1.valuetext) = LOWER(''в договоре'')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = ''M2M_ICCID''
             ) 
             AND dateto > CURRENT_DATE
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid FROM dont_block_extids
            )
            AND ext.idr IN (
                SELECT extid FROM active_extids
            )
            AND (
                (
                    split_part(ep.valuetext, '' '', 1) = ''UPOS''
                    AND st.name IN (''POS-терминал'', ''SmartPos'')
                    AND CASE 
                        WHEN position('' '', ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('' '', ep.valuetext) + 1), ''DD.MM.YYYY'')  
                        ELSE
                            NULL  
                    END < CURRENT_DATE - INTERVAL ''2 months''
                )
                OR
                (
                    split_part(ep.valuetext, ''_'', 1) = ''SDWAN''
                    AND st.name IN (''SDMAN УС'', ''SDMAN ППКО/ВСП'')
                    AND CASE
                        WHEN position(''_'', ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10), ''YYYY-MM-DD'')
                        ELSE 
                            NULL
                    END < CURRENT_DATE - INTERVAL ''2 months''
                )
            )
            AND (op.name = ''Сбербанк Телеком(М2М)'' OR op.name = ''МТС (М2М)'')
            AND ext.idr NOT IN (
                SELECT extid 
                FROM relevant_calls
            );
    ', prev_month_2, prev_month_1, current_month);

    RETURN QUERY EXECUTE query;
END;
$$ LANGUAGE plpgsql;


CREATE OR REPLACE FUNCTION get_filtered_m2m_data(current_date DATE)
RETURNS TABLE (
    operator VARCHAR,
    msisdn VARCHAR,
    iccid VARCHAR,
    m2m_type VARCHAR,
    m2m_usemode VARCHAR,
    tb VARCHAR,
    gosb VARCHAR,
    status VARCHAR,
    block_date DATE
) AS $$
DECLARE
    current_month TEXT;
    prev_month_1 TEXT;
    prev_month_2 TEXT;
    query TEXT;
BEGIN
    current_month := to_char(current_date, 'YYYYMM');
    prev_month_1 := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');

    query := format('
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position(''_'', ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, ''_'', 1) || ''_'' || substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL::DATE AS block_date
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accoutid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid   
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gostoterbankid 
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > current_date    
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr      
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id 
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = ''M2M_SIM_STATUS_CONTRACT''
            )
            AND p1.dateto > current_date
            AND LOWER(p1.valuetext) = LOWER(''в договоре'')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = ''M2M_ICCID''
             ) 
             AND dateto > current_date
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = ''M2M_DONT_BLOCK''
                )
                AND dateto > current_date
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr 
                    FROM dbo.tarPropertyField 
                    WHERE privatename = ''M2M_STATUS''
                )
                AND dateto > current_date
                AND valuetext != ''Первоначальная блокировка''
                AND (valuetext = ''Активен'' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, '' '', 1) = ''UPOS''
                    AND st.name IN (''POS-терминал'', ''SmartPos'')
                    AND CASE 
                        WHEN position('' '', ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('' '', ep.valuetext) + 1), ''DD.MM.YYYY'')  
                        ELSE
                            NULL  
                    END < current_date - INTERVAL ''2 months''
                )
                OR
                (
                    split_part(ep.valuetext, ''_'', 1) = ''SDWAN''
                    AND st.name IN (''SDMAN УС'', ''SDMAN ППКО/ВСП'')
                    AND CASE
                        WHEN position(''_'', ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10), ''YYYY-MM-DD'')
                        ELSE 
                            NULL
                    END < current_date - INTERVAL ''2 months''
                )
            )
            AND (op.name = ''Сбербанк Телеком(М2М)'' OR op.name = ''МТС (М2М)'')
            AND ext.idr NOT IN (
                SELECT extid FROM aggmobilecalls_' || prev_month_2 || ' WHERE servicetype = ''интернет''
                UNION ALL
                SELECT extid FROM aggmobilecalls_' || prev_month_1 || ' WHERE servicetype = ''интернет''
                UNION ALL
                SELECT extid FROM aggmobilecalls_' || current_month || ' WHERE servicetype = ''интернет''
            );
    ');

    RETURN QUERY EXECUTE query;
END;
$$ LANGUAGE plpgsql;



CREATE OR REPLACE FUNCTION dbo.test_get_filtered_m2m_data(input_date DATE)
RETURNS TABLE(
    operator CHARACTER VARYING,
    msisdn CHARACTER VARYING,
    iccid CHARACTER VARYING,
    m2m_type CHARACTER VARYING,
    m2m_usemode CHARACTER VARYING,
    tb CHARACTER VARYING,
    gosb CHARACTER VARYING,
    status CHARACTER VARYING,
    block_date DATE
) 
LANGUAGE plpgsql
AS $$
DECLARE
    current_month TEXT;
    prev_month_1 TEXT;
    prev_month_2 TEXT;
    query TEXT;
BEGIN
    current_month := to_char(current_date, 'YYYYMM');
    prev_month_1 := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');

    query := format('
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position(''_'', ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, ''_'', 1) || ''_'' || substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS block_date
        FROM
            bo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accountid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gosbtoterbankid
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = ''M2M_SIM_STATUS_CONTRACT''
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = ''в договоре''
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty
             WHERE propertyfieldid = (
                 SELECT idr
                 FROM dbo.tarPropertyField
                 WHERE privatename = ''M2M_ICCID''
             )
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty
                WHERE propertyfieldid = (
                    SELECT idr
                    FROM dbo.tarPropertyField
                    WHERE privatename = ''M2M_DONT_BLOCK''
                )
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty
                WHERE propertyfieldid = (
                    SELECT idr
                    FROM dbo.tarPropertyField
                    WHERE privatename = ''M2M_STATUS''
                )
                AND dateto > NOW()
                AND valuetext != ''Первоначальная блокировка''
                AND (valuetext = ''Активен'' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, '' '', 1) = ''UPOS''
                    AND st.name IN (''POS-терминал'', ''SmartPos'')
                    AND CASE 
                        WHEN position('' '' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('' '' IN ep.valuetext) + 1), ''DD.MM.YYYY'')
                        ELSE
                            NULL
                    END < date_trunc(''month'', NOW()) - INTERVAL ''2 months''
                )
                OR
                (
                    split_part(ep.valuetext, ''_'', 1) = ''SDWAN''
                    AND st.name IN (''SDMAN УС'', ''SDMAN ППКО/ВСП'')
                    AND CASE
                        WHEN position(''_'', ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10), ''YYYY-MM-DD'')
                        ELSE 
                            NULL
                    END < date_trunc(''month'', NOW()) - INTERVAL ''2 months''
                )
            )
            AND (op.name = ''Сбербанк Телеком(М2М)'' OR op.name = ''МТС (М2М)'')
            AND ext.idr NOT IN (
                SELECT extid FROM dbo.aggmobilecalls_' || prev_month_2 || ' WHERE servicetype = ''Интернет''
                AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
                UNION ALL
                SELECT extid FROM dbo.aggmobilecalls_' || prev_month_1 || ' WHERE servicetype = ''Интернет''
                AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
                UNION ALL
                SELECT extid FROM dbo.aggmobilecalls_' || current_month || ' WHERE servicetype = ''Интернет''
                AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
            );
    ');

    RETURN QUERY EXECUTE query;
END;
$$;


SELECT
        op.name AS operator,
        ext.ext AS msisdn,
        iccid.valuetext AS iccid,
        st.name AS m2m_type,
        CASE
            WHEN position('_' IN ep.valuetext) > 0 THEN
                split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
            ELSE
                ep.valuetext
        END AS m2m_usemode,
        tb.fullname AS tb,
        g.name AS gosb,
        NULL AS status,
        NULL AS block_date
    FROM
        bo.m2mextension ext
    JOIN
        dbo.taraccounts acc ON ext.accountid = acc.id
    JOIN
        dbo.taroperator op ON acc.operatorid = op.idr
    JOIN
        dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid
    JOIN
        dbo.catgosbtoterbank g ON g.id = gm.gosbtoterbankid
    JOIN
        dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()
    JOIN
        dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr
    JOIN
        dbo.mobsimtypes st ON stc.simtypeid = st.id
    JOIN
        dbo.m2mextensionproperty ep ON ext.idr = ep.extid
    JOIN
        dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
            SELECT idr
            FROM dbo.tarPropertyField
            WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
        )
        AND p1.dateto > NOW()
        AND LOWER(p1.valuetext) = 'в договоре'
    LEFT JOIN
        (SELECT extid, valuetext
         FROM dbo.m2mextensionproperty
         WHERE propertyfieldid = (
             SELECT idr
             FROM dbo.tarPropertyField
             WHERE privatename = 'M2M_ICCID'
         )
         AND dateto > NOW()
        ) iccid ON ext.idr = iccid.extid
    JOIN
        dbo.catterbank tb ON tb.id = acc.terbankid
    WHERE
        ext.idr NOT IN (
            SELECT extid
            FROM dbo.m2mextensionproperty
            WHERE propertyfieldid = (
                SELECT idr
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_DONT_BLOCK'
            )
            AND dateto > NOW()
        )
        AND ext.idr IN (
            SELECT extid
            FROM dbo.m2mextensionproperty
            WHERE propertyfieldid = (
                SELECT idr
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_STATUS'
            )
            AND dateto > NOW()
            AND valuetext != 'Первоначальная блокировка'
            AND (valuetext = 'Активен' OR valuetext IS NULL)
        )
        AND (
            (
                split_part(ep.valuetext, ' ', 1) = 'UPOS'
                AND st.name IN ('POS-терминал', 'SmartPos')
                AND CASE 
                    WHEN position(' ' IN ep.valuetext) > 0 THEN
                        to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < date_trunc('month', NOW()) - INTERVAL '2 months'
            )
            OR
            (
                split_part(ep.valuetext, '_', 1) = 'SDWAN'
                AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
                AND CASE
                    WHEN position('_' IN ep.valuetext) > 0 THEN
                        to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                    ELSE 
                        NULL
                END < date_trunc('month', NOW()) - INTERVAL '2 months'
            )
        )
        AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
        AND ext.idr NOT IN (
            SELECT extid FROM dbo.aggmobilecalls_' || to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM') || ' WHERE servicetype = ''Интернет''
            AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
            UNION ALL
            SELECT extid FROM dbo.aggmobilecalls_' || to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM') || ' WHERE servicetype = ''Интернет''
            AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
            UNION ALL
            SELECT extid FROM dbo.aggmobilecalls_' || to_char(current_date, 'YYYYMM') || ' WHERE servicetype = ''Интернет''
            AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
        );

CREATE OR REPLACE FUNCTION dbo.test_get_filtered_m2m_data(input_date DATE)
RETURNS TABLE (
    operator CHARACTER VARYING,
    msisdn CHARACTER VARYING,
    iccid CHARACTER VARYING,
    m2m_type CHARACTER VARYING,
    m2m_usemode CHARACTER VARYING,
    tb CHARACTER VARYING,
    gosb CHARACTER VARYING,
    status CHARACTER VARYING,
    block_date DATE
) 
LANGUAGE plpgsql
AS $$
DECLARE
    current_month TEXT;
    prev_month_1 TEXT;
    prev_month_2 TEXT;
    query TEXT;
BEGIN
    current_month := to_char(current_date, 'YYYYMM');
    prev_month_1 := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');

    query := format($$
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position('_' IN ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, '_', 1) || '_' || substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS block_date
        FROM
            bo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accountid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gosbtoterbankid
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr
                FROM dbo.tarPropertyField
                WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = 'в договоре'
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty
             WHERE propertyfieldid = (
                 SELECT idr
                 FROM dbo.tarPropertyField
                 WHERE privatename = 'M2M_ICCID'
             )
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty
                WHERE propertyfieldid = (
                    SELECT idr
                    FROM dbo.tarPropertyField
                    WHERE privatename = 'M2M_DONT_BLOCK'
                )
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty
                WHERE propertyfieldid = (
                    SELECT idr
                    FROM dbo.tarPropertyField
                    WHERE privatename = 'M2M_STATUS'
                )
                AND dateto > NOW()
                AND valuetext != 'Первоначальная блокировка'
                AND (valuetext = 'Активен' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, ' ', 1) = 'UPOS'
                    AND st.name IN ('POS-терминал', 'SmartPos')
                    AND CASE 
                        WHEN position(' ' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(' ' IN ep.valuetext) + 1), 'DD.MM.YYYY')
                        ELSE
                            NULL
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
                OR
                (
                    split_part(ep.valuetext, '_', 1) = 'SDWAN'
                    AND st.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
                    AND CASE
                        WHEN position('_' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('_' IN ep.valuetext) + 1, 10), 'YYYY-MM-DD')
                        ELSE 
                            NULL
                    END < date_trunc('month', NOW()) - INTERVAL '2 months'
                )
            )
            AND (op.name = 'Сбербанк Телеком(М2М)' OR op.name = 'МТС (М2М)')
            AND ext.idr NOT IN (
                SELECT extid FROM dbo.aggmobilecalls_''' || prev_month_2 || ''' WHERE servicetype = ''Интернет''
                AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
                UNION ALL
                SELECT extid FROM dbo.aggmobilecalls_''' || prev_month_1 || ''' WHERE servicetype = ''Интернет''
                AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
                UNION ALL
                SELECT extid FROM dbo.aggmobilecalls_''' || current_month || ''' WHERE servicetype = ''Интернет''
                AND (operator = ''Сбербанк Телеком'' OR operator = ''МТС (М2М)'')
            );
    $$);

    RETURN QUERY EXECUTE query;
END;
$$;

DECLARE
    current_month TEXT;
    prev_month_1 TEXT;
    prev_month_2 TEXT;
    query TEXT;
BEGIN
    current_month := to_char(current_date, 'YYYYMM');
    prev_month_1 := to_char(date_trunc('month', current_date) - INTERVAL '1 month', 'YYYYMM');
    prev_month_2 := to_char(date_trunc('month', current_date) - INTERVAL '2 months', 'YYYYMM');

    query := format('
        SELECT
            op.name AS operator,
            ext.ext AS msisdn,
            iccid.valuetext AS iccid,
            st.name AS m2m_type,
            CASE
                WHEN position(''_'', ep.valuetext) > 0 THEN
                    split_part(ep.valuetext, ''_'', 1) || ''_'' || substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10)
                ELSE
                    ep.valuetext
            END AS m2m_usemode,
            tb.fullname AS tb,
            g.name AS gosb,
            NULL AS status,
            NULL AS block_date
        FROM
            dbo.m2mextension ext
        JOIN
            dbo.taraccounts acc ON ext.accountid = acc.id
        JOIN
            dbo.taroperator op ON acc.operatorid = op.idr
        JOIN
            dbo.m2mpropgosbtoterbank gm ON ext.idr = gm.extid
        JOIN
            dbo.catgosbtoterbank g ON g.id = gm.gosbtoterbankid
        JOIN
            dbo.m2mpropsimtypestoterbank stp ON ext.idr = stp.extid AND stp.dateto > NOW()
        JOIN
            dbo.mobsimtypesclassestoterbank stc ON stp.simtypesid = stc.idr
        JOIN
            dbo.mobsimtypes st ON stc.simtypeid = st.id
        JOIN
            dbo.m2mextensionproperty ep ON ext.idr = ep.extid
        JOIN
            dbo.m2mextensionproperty p1 ON ext.idr = p1.extid AND p1.propertyfieldid = (
                SELECT idr 
                FROM dbo.tarPropertyField
                WHERE privatename = ''M2M_SIM_STATUS_CONTRACT''
            )
            AND p1.dateto > NOW()
            AND LOWER(p1.valuetext) = LOWER(''в договоре'')
        LEFT JOIN
            (SELECT extid, valuetext
             FROM dbo.m2mextensionproperty 
             WHERE propertyfieldid = (
                 SELECT idr 
                 FROM dbo.tarPropertyField 
                 WHERE privatename = ''M2M_ICCID''
             )
             AND dateto > NOW()
            ) iccid ON ext.idr = iccid.extid
        JOIN
            dbo.catterbank tb ON tb.id = acc.terbankid
        WHERE
            ext.idr NOT IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr
                    FROM dbo.tarPropertyField
                    WHERE privatename = ''M2M_DONT_BLOCK''
                )
                AND dateto > NOW()
            )
            AND ext.idr IN (
                SELECT extid
                FROM dbo.m2mextensionproperty 
                WHERE propertyfieldid = (
                    SELECT idr
                    FROM dbo.tarPropertyField
                    WHERE privatename = ''M2M_STATUS''
                )
                AND dateto > NOW()
                AND valuetext != ''Первоначальная блокировка''
                AND (valuetext = ''Активен'' OR valuetext IS NULL)
            )
            AND (
                (
                    split_part(ep.valuetext, '' '', 1) = ''UPOS''
                    AND st.name IN (''POS-терминал'', ''SmartPos'')
                    AND CASE 
                        WHEN position('' '' IN ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position('' '' IN ep.valuetext) + 1), ''DD.MM.YYYY'')
                        ELSE
                            NULL
                    END < date_trunc(''month'', NOW()) - INTERVAL ''2 months''
                )
                OR
                (
                    split_part(ep.valuetext, ''_'', 1) = ''SDWAN''
                    AND st.name IN (''SDMAN УС'', ''SDMAN ППКО/ВСП'')
                    AND CASE
                        WHEN position(''_'', ep.valuetext) > 0 THEN
                            to_date(substring(ep.valuetext, position(''_'', ep.valuetext) + 1, 10), ''YYYY-MM-DD'')
                        ELSE 
                            NULL
                    END < date_trunc(''month'', NOW()) - INTERVAL ''2 months''
                )
            )
            AND (op.name = ''Сбербанк Телеком(М2М)'' OR op.name = ''МТС (М2М)'')
    ');
    
    -- Добавьте это перед RETURN QUERY EXECUTE
    RAISE NOTICE 'Executing query: %', query;

    RETURN QUERY EXECUTE query;
END;
$$;






