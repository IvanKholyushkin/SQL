SELECT 
    ext.ext,
    CASE 
        WHEN position('_' IN ext.remark) > 0 THEN
            split_part(ext.remark, '_', 1)
        WHEN position(' ' IN ext.remark) > 0 THEN
            split_part(ext.remark, ' ', 1)
        ELSE
            ext.remark
    END AS name,
    CASE 
        WHEN position('_' IN ext.remark) > 0 THEN
            to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
        WHEN position(' ' IN ext.remark) > 0 THEN
            to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
        ELSE
            NULL
    END AS extracted_date,
    p2.extid,
    p2.valuetext AS usemode_valuetext,
    p1.valuetext AS sim_status_contract,
    iccid.valuetext AS ICCID
FROM 
    dbo.m2mextension ext
JOIN 
    dbo.m2mpropsimtypestoterbank typter ON ext.idr = typter.extid AND typter.dateto > NOW()
JOIN 
    dbo.mobsimtypesclassestoterbank classter ON typter.simtypesid = classter.idr
JOIN 
    dbo.mobsimtypes typ ON classter.simtypeid = typ.id
JOIN 
    dbo.m2mextenssionproperty p2 ON ext.idr = p2.extid
JOIN 
    dbo.m2mextenssionproperty p1 ON ext.idr = p1.extid
LEFT JOIN 
    (SELECT extid, valuetext 
     FROM dbo.m2mextenssionproperty 
     WHERE propertyfiedid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
WHERE 
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        ) 
        AND dateto > NOW()
    )
    AND ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext = 'Первоначальная блокировка'
    ) 
    AND (
        (
            split_part(ext.remark, ' ', 1) = 'UPOS'
            AND typ."name" IN ('POS-терминал', 'SmartPos')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        ) 
        OR 
        (
            split_part(ext.remark, ' ', 1) = 'SDWAN'
            AND typ."name" IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        )
    )
    AND p1.propertyfiedid = (
        SELECT idr 
        FROM dbo.tarPropertyField 
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    ) 
    AND p1.dateto > NOW() 
    AND LOWER(p1.valuetext) = LOWER('в договоре');

____________________________________________________________
SELECT 
    ext.ext,
    ext.remark,
    p2.extid,
    p2.valuetext AS usemode_valuetext,
    p1.valuetext AS sim_status_contract,
    iccid.valuetext AS ICCID
FROM 
    dbo.m2mextension ext
JOIN 
    dbo.m2mpropsimtypestoterbank typter ON ext.idr = typter.extid AND typter.dateto > NOW()
JOIN 
    dbo.mobsimtypesclassestoterbank classter ON typter.simtypesid = classter.idr
JOIN 
    dbo.mobsimtypes typ ON classter.simtypeid = typ.id
JOIN 
    dbo.m2mextenssionproperty p2 ON ext.idr = p2.extid
JOIN 
    dbo.m2mextenssionproperty p1 ON ext.idr = p1.extid
LEFT JOIN 
    (SELECT extid, valuetext 
     FROM dbo.m2mextenssionproperty 
     WHERE propertyfiedid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
WHERE 
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        ) 
        AND dateto > NOW()
    )
    AND ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextenssionproperty
        WHERE propertyfiedid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext = 'Первоначальная блокировка'
    ) 
    AND (
        (
            split_part(ext.remark, ' ', 1) = 'UPOS'
            AND typ."name" IN ('POS-терминал', 'SmartPos')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        ) 
        OR 
        (
            split_part(ext.remark, ' ', 1) = 'SDWAN'
            AND typ."name" IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE 
                    WHEN position('_' IN ext.remark) > 0 THEN
                        to_timestamp(substring(ext.remark, position('_' IN ext.remark) + 1), 'YYYY-MM-DD HH24:MI:SS')
                    WHEN position(' ' IN ext.remark) > 0 THEN
                        to_date(substring(ext.remark, position(' ' IN ext.remark) + 1), 'DD.MM.YYYY')
                    ELSE
                        NULL
                END < NOW() - INTERVAL '2 months'
        )
    )
    AND p1.propertyfiedid = (
        SELECT idr 
        FROM dbo.tarPropertyField 
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    ) 
    AND p1.dateto > NOW() 
    AND LOWER(p1.valuetext) = LOWER('в договоре');
__________________________________________________________________________________________
SELECT
    op.name AS operator,
    ext.ext AS msisdn,
    iccid.valuetext AS iccid,
    typ.name AS m2m_usemode,
    NULL AS status_block,
    NULL AS tb,
    c.name AS gosb,
    NULL AS date_block,
    p1.valuetext AS dog_status
FROM
    dbo.m2mextension ext
JOIN
    dbo.taraccounts acc ON ext.accoutid = acc.id
JOIN
    dbo.taroperator op ON acc.operatorid = op.idr
JOIN
    dbo.m2mpropgosbtoterbank mm ON ext.idr = mm.extid   
JOIN
    dbo.catgosbtoterbank c ON c.id = mm.gostoterbankid 
JOIN
    dbo.m2mpropsimtypestoterbank typer ON ext.idr = typer.extid AND typer.dateto > NOW()    
JOIN
    dbo.mobsimtypesclassestoterbank classter ON typer.simtypesid = classter.idr      
JOIN
    dbo.mobsimtypes typ ON classter.simtypeid = typ.id 
JOIN
    dbo.m2mextensionproperty p2 ON ext.idr = p2.extid
JOIN
    dbo.m2mextensionproperty p1 ON ext.idr = p1.extid
LEFT JOIN
    (SELECT extid, valuetext
     FROM dbo.m2mextensionproperty 
     WHERE propertyfieldid = (
         SELECT idr 
         FROM dbo.tarPropertyField 
         WHERE privatename = 'M2M_ICCID'
     ) 
     AND dateto > NOW()
    ) iccid ON ext.idr = iccid.extid
WHERE
    ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextensionproperty 
        WHERE propertyfieldid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_DONT_BLOCK'
        )
    AND dateto > NOW()
    )
    AND ext.idr NOT IN (
        SELECT extid
        FROM dbo.m2mextensionproperty 
        WHERE propertyfieldid = (
            SELECT idr 
            FROM dbo.tarPropertyField 
            WHERE privatename = 'M2M_STATUS'
        )
        AND dateto > NOW()
        AND valuetext = 'Первоначальная блокировка'
    )
    AND p1.propertyfieldid = (
        SELECT idr 
        FROM dbo.tarPropertyField
        WHERE privatename = 'M2M_SIM_STATUS_CONTRACT'
    )
    AND p1.dateto > NOW()
    AND LOWER(p1.valuetext) = LOWER('в договоре')
    AND (
        (
            split_part(p2.valuetext, ' ', 1) = 'UPOS'
            AND typ.name IN ('POS-терминал', 'SmartPos')
            AND CASE 
                WHEN position(' ' IN p2.valuetext) > 0 THEN
                    to_date(substring(p2.valuetext, position(' ' IN p2.valuetext) + 1), 'DD.MM.YYYY')  
                ELSE
                    NULL  
            END < date_trunc('month', NOW()) - INTERVAL '2 months'
        )
        OR
        (
            split_part(p2.valuetext, '_', 1) = 'SDWAN'
            AND typ.name IN ('SDMAN УС', 'SDMAN ППКО/ВСП')
            AND CASE
                WHEN position('_' IN p2.valuetext) > 0 THEN
                    to_date(substring(p2.valuetext, position('_' IN p2.valuetext) + 1), 'YYYY-MM-DD')
                ELSE 
                    NULL
                END < date_trunc('month', NOW()) - INTERVAL '2 months'        
        )
    );


